



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="A memory leak detection library for Android">
      
      
        <link rel="canonical" href="https://square.github.io/leakcanary/recipes/">
      
      
        <meta name="author" content="Square, Inc.">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../images/logo.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.0">
    
    
      
        <title>Code recipes - LeakCanary</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.1b62728e.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#ff7043">
      
    
    
      <script src="../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "None", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="deep-orange" data-md-color-accent="deep-purple">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#code-recipes" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://square.github.io/leakcanary/" title="LeakCanary" class="md-header-nav__button md-logo">
          
            <img src="../images/logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              LeakCanary
            </span>
            <span class="md-header-nav__topic">
              
                Code recipes
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/square/leakcanary/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    LeakCanary
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." class="md-tabs__link">
        Overview
      </a>
    
  </li>

      
        
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../fundamentals/" class="md-tabs__link">
          Fundamentals
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="./" class="md-tabs__link md-tabs__link--active">
          Help & Community
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../shark/" class="md-tabs__link">
          Shark
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../api/leakcanary-android-core/leakcanary/" class="md-tabs__link">
          LeakCanary API
        </a>
      
    </li>
  

      
        
      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://square.github.io/leakcanary/" title="LeakCanary" class="md-nav__button md-logo">
      
        <img src="../images/logo.png" width="48" height="48">
      
    </a>
    LeakCanary
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/square/leakcanary/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    LeakCanary
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../getting_started/" title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Fundamentals
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Fundamentals
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../fundamentals/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../fundamentals-how-leakcanary-works/" title="How LeakCanary works" class="md-nav__link">
      How LeakCanary works
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../fundamentals-fixing-a-memory-leak/" title="Fixing a memory leak" class="md-nav__link">
      Fixing a memory leak
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Help & Community
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Help & Community
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Code recipes
      </label>
    
    <a href="./" title="Code recipes" class="md-nav__link md-nav__link--active">
      Code recipes
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#watching-objects-with-a-lifecycle" class="md-nav__link">
    Watching objects with a lifecycle
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    Configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disabling-leakcanary" class="md-nav__link">
    Disabling LeakCanary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#counting-retained-instances-in-production" class="md-nav__link">
    Counting retained instances in production
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-leakcanary-in-instrumentation-tests" class="md-nav__link">
    Running LeakCanary in instrumentation tests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#android-tv" class="md-nav__link">
    Android TV
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#icon-and-label" class="md-nav__link">
    Icon and label
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uploading-to-a-server" class="md-nav__link">
    Uploading to a server
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uploading-to-bugsnag" class="md-nav__link">
    Uploading to Bugsnag
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matching-known-library-leaks" class="md-nav__link">
    Matching known library leaks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ignoring-specific-activities-or-fragment-classes" class="md-nav__link">
    Ignoring specific activities or fragment classes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#identifying-leaking-objects-and-labeling-objects" class="md-nav__link">
    Identifying leaking objects and labeling objects
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-the-leakcanary-analysis-in-a-separate-process" class="md-nav__link">
    Running the LeakCanary analysis in a separate process
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-leakcanary-for-different-product-flavors" class="md-nav__link">
    Setting up LeakCanary for different product flavors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extracting-metadata-from-the-heap-dump" class="md-nav__link">
    Extracting metadata from the heap dump
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-leakcanary-with-obfuscated-apps" class="md-nav__link">
    Using LeakCanary with obfuscated apps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#detecting-leaks-in-jvm-applications" class="md-nav__link">
    Detecting leaks in JVM applications
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../faq/" title="FAQ" class="md-nav__link">
      FAQ
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../support/" title="Support" class="md-nav__link">
      Support
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../upgrading-to-leakcanary-2.0/" title="Upgrading to LeakCanary 2" class="md-nav__link">
      Upgrading to LeakCanary 2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../recorded-presentations/" title="Recorded Presentations" class="md-nav__link">
      Recorded Presentations
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../blog-articles/" title="Blog Articles" class="md-nav__link">
      Blog Articles
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://stackoverflow.com/questions/tagged/leakcanary?sort=active" title="Stack Overflow ⏏" class="md-nav__link">
      Stack Overflow ⏏
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-8" type="checkbox" id="nav-4-8">
    
    <label class="md-nav__link" for="nav-4-8">
      Contributing
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-8">
        Contributing
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../how_to_help/" title="How to help" class="md-nav__link">
      How to help
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../code_of_conduct/" title="Code of Conduct" class="md-nav__link">
      Code of Conduct
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../dev-env/" title="Dev Environment" class="md-nav__link">
      Dev Environment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../releasing/" title="Releasing" class="md-nav__link">
      Releasing
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Shark
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Shark
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../shark/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2" type="checkbox" id="nav-5-2">
    
    <label class="md-nav__link" for="nav-5-2">
      Shark API
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-2">
        Shark API
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../api/shark/shark/" title="Shark" class="md-nav__link">
      Shark
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/shark-android/shark/" title="Extension: Shark Android" class="md-nav__link">
      Extension: Shark Android
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/shark-graph/shark/" title="Core: Graph" class="md-nav__link">
      Core: Graph
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/shark-hprof/shark/" title="Core: Hprof" class="md-nav__link">
      Core: Hprof
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/shark-log/shark/" title="Core: Logs" class="md-nav__link">
      Core: Logs
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      LeakCanary API
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        LeakCanary API
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../api/leakcanary-android-core/leakcanary/" title="LeakCanary" class="md-nav__link">
      LeakCanary
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/leakcanary-object-watcher-android/leakcanary/" title="ObjectWatcher Android" class="md-nav__link">
      ObjectWatcher Android
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/leakcanary-android-instrumentation/leakcanary/" title="Extension: Instrumentation tests" class="md-nav__link">
      Extension: Instrumentation tests
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/leakcanary-android-process/leakcanary/" title="Extension: Separate process" class="md-nav__link">
      Extension: Separate process
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/leakcanary-object-watcher/leakcanary/" title="Core: ObjectWatcher" class="md-nav__link">
      Core: ObjectWatcher
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../changelog/" title="Change Log" class="md-nav__link">
      Change Log
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#watching-objects-with-a-lifecycle" class="md-nav__link">
    Watching objects with a lifecycle
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    Configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disabling-leakcanary" class="md-nav__link">
    Disabling LeakCanary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#counting-retained-instances-in-production" class="md-nav__link">
    Counting retained instances in production
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-leakcanary-in-instrumentation-tests" class="md-nav__link">
    Running LeakCanary in instrumentation tests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#android-tv" class="md-nav__link">
    Android TV
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#icon-and-label" class="md-nav__link">
    Icon and label
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uploading-to-a-server" class="md-nav__link">
    Uploading to a server
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uploading-to-bugsnag" class="md-nav__link">
    Uploading to Bugsnag
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matching-known-library-leaks" class="md-nav__link">
    Matching known library leaks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ignoring-specific-activities-or-fragment-classes" class="md-nav__link">
    Ignoring specific activities or fragment classes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#identifying-leaking-objects-and-labeling-objects" class="md-nav__link">
    Identifying leaking objects and labeling objects
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-the-leakcanary-analysis-in-a-separate-process" class="md-nav__link">
    Running the LeakCanary analysis in a separate process
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-leakcanary-for-different-product-flavors" class="md-nav__link">
    Setting up LeakCanary for different product flavors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extracting-metadata-from-the-heap-dump" class="md-nav__link">
    Extracting metadata from the heap dump
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-leakcanary-with-obfuscated-apps" class="md-nav__link">
    Using LeakCanary with obfuscated apps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#detecting-leaks-in-jvm-applications" class="md-nav__link">
    Detecting leaks in JVM applications
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
				  
				<span style="float: right">🤔 Documentation issue? <a href="https://github.com/square/leakcanary/issues/new?assignees=&labels=type%3A+documentation&template=4-doc.md&title=Doc%20issue%20with%20recipes/%20page">Report</a> or <a href="https://github.com/square/leakcanary/edit/master/docs/recipes.md">edit</a></span>
                  
                
                
                <h1 id="code-recipes">Code Recipes<a class="headerlink" href="#code-recipes" title="Permanent link">&para;</a></h1>
<div class="admonition bug">
<p class="admonition-title">Bug</p>
<p>If you think a recipe might be missing or you&rsquo;re not sure that what you&rsquo;re trying to achieve is possible with the current APIs, please <a href="https://github.com/square/leakcanary/issues/new/choose">file an issue</a>. Your feedback help us make LeakCanary better for the entire community.</p>
</div>
<h2 id="watching-objects-with-a-lifecycle">Watching objects with a lifecycle<a class="headerlink" href="#watching-objects-with-a-lifecycle" title="Permanent link">&para;</a></h2>
<p>In your application, you may have other objects with a lifecycle, such as fragments, services, Dagger components, etc. Use <a href="/leakcanary/api/leakcanary-object-watcher-android/leakcanary/-app-watcher/object-watcher/">AppWatcher.objectWatcher</a> to watch instances that should be garbage collected:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyService</span> <span class="p">:</span> <span class="n">Service</span> <span class="p">{</span>

  <span class="c1">// ...</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onDestroy</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onDestroy</span><span class="p">()</span>
    <span class="n">AppWatcher</span><span class="p">.</span><span class="n">objectWatcher</span><span class="p">.</span><span class="n">watch</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s">&quot;MyService received Service#onDestroy() callback&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h2 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permanent link">&para;</a></h2>
<p>LeakCanary has a default configuration that should work well for most apps. You can also customize it to your needs. The LeakCanary configuration is held by two singleton objects (<code>AppWatcher</code> and <code>LeakCanary</code>) and can be updated at any time. Most developers configure LeakCanary in their <strong>debug</strong> <a href="https://developer.android.com/reference/android/app/Application">Application</a> class:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">DebugExampleApplication</span> <span class="p">:</span> <span class="n">ExampleApplication</span><span class="p">()</span> <span class="p">{</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">()</span>
    <span class="n">AppWatcher</span><span class="p">.</span><span class="n">config</span> <span class="p">=</span> <span class="n">AppWatcher</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">watchFragmentViews</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<div class="admonition info">
<p class="admonition-title">Info</p>
<p>You can create a debug application class in your <code>src/debug/java</code> folder. Don&rsquo;t forget to also register it in <code>src/debug/AndroidManifest.xml</code>.</p>
</div>
<p>To customize the detection of retained objects at runtime, update <a href="/leakcanary/api/leakcanary-object-watcher-android/leakcanary/-app-watcher/config/">AppWatcher.config</a>:</p>
<div class="codehilite"><pre><span></span>AppWatcher.config = AppWatcher.config.copy(watchFragmentViews = false)
</pre></div>

<p>In Java, you can use <a href="/leakcanary/api/leakcanary-object-watcher-android/leakcanary/-app-watcher/-config/-builder/">AppWatcher.Config.Builder</a> instead:
<div class="codehilite"><pre><span></span>AppWatcher.Config config = AppWatcher.getConfig().newBuilder()
   .watchFragmentViews(false)
   .build();
AppWatcher.setConfig(config);
</pre></div></p>
<p>To customize the heap dumping &amp; analysis, update <a href="/leakcanary/api/leakcanary-android-core/leakcanary/-leak-canary/config/">LeakCanary.config</a>:</p>
<div class="codehilite"><pre><span></span>LeakCanary.config = LeakCanary.config.copy(retainedVisibleThreshold = 3)
</pre></div>

<p>In Java, you can use <a href="/leakcanary/api/leakcanary-android-core/leakcanary/-leak-canary/-config/-builder/">LeakCanary.Config.Builder</a> instead:
<div class="codehilite"><pre><span></span>LeakCanary.Config config = LeakCanary.getConfig().newBuilder()
   .retainedVisibleThreshold(3)
   .build();
LeakCanary.setConfig(config);
</pre></div></p>
<p>The LeakCanary UI can be configured by overriding the following resources:</p>
<ul>
<li><code>mipmap/leak_canary_icon</code> see <a href="#icon-and-label">Icon and label</a></li>
<li><code>string/leak_canary_display_activity_label</code> see <a href="#icon-and-label">Icon and label</a></li>
<li><code>bool/leak_canary_add_dynamic_shortcut</code> see <a href="#disabling-leakcanary">Disabling LeakCanary</a></li>
<li><code>bool/leak_canary_add_launcher_icon</code> see <a href="#disabling-leakcanary">Disabling LeakCanary</a></li>
<li><code>layout/leak_canary_heap_dump_toast</code> the layout for the toast shown when the heap is dumped</li>
</ul>
<h2 id="disabling-leakcanary">Disabling LeakCanary<a class="headerlink" href="#disabling-leakcanary" title="Permanent link">&para;</a></h2>
<p>Sometimes it&rsquo;s necessary to disable LeakCanary temporarily, for example for a product demo or when running performance tests. You have different options, depending on what you&rsquo;re trying to achieve:</p>
<ul>
<li>Create a build variant that does not include the LeakCanary dependencies, see <a href="#setting-up-leakcanary-for-different-product-flavors">Setting up LeakCanary for different product flavors</a>.</li>
<li>Disable the tracking of retained objects: <code>AppWatcher.config = AppWatcher.config.copy(enabled = false)</code>.</li>
<li>Disable the heap dumping &amp; analysis: <code>LeakCanary.config = LeakCanary.config.copy(dumpHeap = false)</code>.</li>
<li>Hide the leak display activity launcher icon: override <code>R.bool.leak_canary_add_launcher_icon</code> or call <code>LeakCanary.showLeakDisplayActivityLauncherIcon(false)</code></li>
</ul>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>When you set <code>AppWatcher.config.enabled</code> to false, <code>AppWatcher.objectWatcher</code> will stop creating weak references to destroyed objects.</p>
<p>If instead you set <code>LeakCanary.Config.dumpHeap</code> to false, <code>AppWatcher.objectWatcher</code> will still keep track of retained objects, and LeakCanary will look for these objects when you change <code>LeakCanary.Config.dumpHeap</code> back to true.</p>
</div>
<h2 id="counting-retained-instances-in-production">Counting retained instances in production<a class="headerlink" href="#counting-retained-instances-in-production" title="Permanent link">&para;</a></h2>
<p>The <code>com.squareup.leakcanary:leakcanary-android</code> dependency should only be used in debug builds. It depends on <code>com.squareup.leakcanary:leakcanary-object-watcher-android</code> which you can use in production to track and count retained instances.</p>
<p>In your <code>build.gradle</code>:</p>
<div class="codehilite"><pre><span></span>dependencies {
  implementation &#39;com.squareup.leakcanary:leakcanary-object-watcher-android:2.0-beta-5&#39;
}
</pre></div>

<p>In your leak reporting code:
<div class="codehilite"><pre><span></span><span class="k">val</span> <span class="py">retainedInstanceCount</span> <span class="p">=</span> <span class="n">AppWatcher</span><span class="p">.</span><span class="n">objectWatcher</span><span class="p">.</span><span class="n">retainedObjectCount</span>
</pre></div></p>
<h2 id="running-leakcanary-in-instrumentation-tests">Running LeakCanary in instrumentation tests<a class="headerlink" href="#running-leakcanary-in-instrumentation-tests" title="Permanent link">&para;</a></h2>
<p>Running leak detection in UI tests means you can detect memory leaks automatically in Continuous Integration prior to those leaks being merged into the codebase. However, as LeakCanary runs with a 5 seconds delay and freezes the VM to take a heap dump, this can introduce flakiness to the UI tests. Therefore it is automatically disabled by setting <code>LeakCanary.config.dumpHeap</code> to <code>false</code> when JUnit is on the runtime classpath.</p>
<p>LeakCanary provides an artifact dedicated to detecting leaks in UI tests which provides a run listener that waits for the end of a test, and if the test succeeds then it look for retained objects, trigger a heap dump if needed and perform an analysis.</p>
<p>To set it up, add the <code>leakcanary-android-instrumentation</code> dependency to your instrumentation tests:</p>
<div class="codehilite"><pre><span></span>androidTestImplementation &quot;com.squareup.leakcanary:leakcanary-android-instrumentation:${leakCanaryVersion}&quot;
</pre></div>

<p>Add the dedicated run listener to <code>defaultConfig</code> in your <code>build.gradle</code>:</p>
<div class="codehilite"><pre><span></span>android {
  defaultConfig {
    // ...

    testInstrumentationRunner &quot;android.support.test.runner.AndroidJUnitRunner&quot;
    testInstrumentationRunnerArgument &quot;listener&quot;, &quot;leakcanary.FailTestOnLeakRunListener&quot;
  }
}
</pre></div>

<p>Run the instrumentation tests:</p>
<div class="codehilite"><pre><span></span>./gradlew leakcanary-android-sample:connectedCheck
</pre></div>

<p>You can extend <code>FailTestOnLeakRunListener</code> to customize the behavior.</p>
<h2 id="android-tv">Android TV<a class="headerlink" href="#android-tv" title="Permanent link">&para;</a></h2>
<p>LeakCanary works on Android TV devices (FireTV, Nexus player, Nvidia Shield, MiBox, etc.) without any additional setup. However, there are couple things you need to be aware of:</p>
<ul>
<li>Android TV doesn&rsquo;t have notifications. LeakCanary will display Toast messages when objects become retained and when leak analysis completes. You can also check Logcat for more details.</li>
<li>Due to lack of notifications, the only way to <strong>manually</strong> trigger a heap dump is to background the app.  </li>
<li>There&rsquo;s a <a href="https://issuetracker.google.com/issues/141429184">bug on API 26+ devices</a> that prevents the activity that displays leaks from appearing in apps list. As a workaround, LeakCanary prints an <code>adb shell</code> command in Logcat after heap dump analysis that launches leak list activity:
    <div class="codehilite"><pre><span></span>adb shell am start -n &quot;com.your.package.name/leakcanary.internal.activity.LeakLauncherActivity&quot;
</pre></div></li>
<li>Some Android TV devices have very little memory available per app process and this might impact LeakCanary. <a href="#running-the-leakcanary-analysis-in-a-separate-process">Running the LeakCanary analysis in a separate process</a> might help in such cases.</li>
</ul>
<h2 id="icon-and-label">Icon and label<a class="headerlink" href="#icon-and-label" title="Permanent link">&para;</a></h2>
<p>The activity that displays leaks comes with a default icon and label, which you can change by providing <code>R.mipmap.leak_canary_icon</code> and <code>R.string.leak_canary_display_activity_label</code> in your app:</p>
<div class="codehilite"><pre><span></span>res/
  mipmap-hdpi/
    leak_canary_icon.png
  mipmap-mdpi/
    leak_canary_icon.png
  mipmap-xhdpi/
    leak_canary_icon.png
  mipmap-xxhdpi/
    leak_canary_icon.png
  mipmap-xxxhdpi/
    leak_canary_icon.png
   mipmap-anydpi-v26/
     leak_canary_icon.xml
</pre></div>

<div class="codehilite"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;resources&gt;</span>
  <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;leak_canary_display_activity_label&quot;</span><span class="nt">&gt;</span>MyLeaks<span class="nt">&lt;/string&gt;</span>
<span class="nt">&lt;/resources&gt;</span>
</pre></div>

<h2 id="uploading-to-a-server">Uploading to a server<a class="headerlink" href="#uploading-to-a-server" title="Permanent link">&para;</a></h2>
<p>You can change the default behavior to upload the analysis result to a server of your choosing.</p>
<p>Create a custom <a href="/leakcanary/api/leakcanary-android-core/leakcanary/-on-heap-analyzed-listener/">OnHeapAnalyzedListener</a> that delegates to <a href="/leakcanary/api/leakcanary-android-core/leakcanary/-default-on-heap-analyzed-listener/">DefaultOnHeapAnalyzedListener</a>: </p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">LeakUploader</span> <span class="p">:</span> <span class="n">OnHeapAnalyzedListener</span> <span class="p">{</span>

  <span class="k">val</span> <span class="py">defaultListener</span> <span class="p">=</span> <span class="n">DefaultOnHeapAnalyzedListener</span><span class="p">.</span><span class="n">create</span><span class="p">()</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onHeapAnalyzed</span><span class="p">(</span><span class="n">heapAnalysis</span><span class="p">:</span> <span class="n">HeapAnalysis</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">TODO</span><span class="p">(</span><span class="s">&quot;Upload heap analysis to server&quot;</span><span class="p">)</span>

    <span class="c1">// Delegate to default behavior (notification and saving result)</span>
    <span class="n">defaultListener</span><span class="p">.</span><span class="n">onHeapAnalyzed</span><span class="p">(</span><span class="n">heapAnalysis</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Set <a href="/leakcanary/api/leakcanary-android-core/leakcanary/-leak-canary/-config/on-heap-analyzed-listener/">LeakCanary.config.onHeapAnalyzedListener</a>:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">DebugExampleApplication</span> <span class="p">:</span> <span class="n">ExampleApplication</span><span class="p">()</span> <span class="p">{</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">()</span>
    <span class="n">LeakCanary</span><span class="p">.</span><span class="n">config</span> <span class="p">=</span> <span class="n">LeakCanary</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">onHeapAnalyzedListener</span> <span class="p">=</span> <span class="n">LeakUploader</span><span class="p">())</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h2 id="uploading-to-bugsnag">Uploading to Bugsnag<a class="headerlink" href="#uploading-to-bugsnag" title="Permanent link">&para;</a></h2>
<p>A leak trace has a lot in common with a stack trace, so if you lack the engineering resources to build a backend for LeakCanary, you can instead upload leak traces to a crash reporting backend. The client needs to support grouping via custom client-side hashing as well as custom metadata with support for newlines.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>As of this writing, the only known library suitable for uploading leaks is the Bugsnag client. If you managed to make it work with another library, please <a href="https://github.com/square/leakcanary/issues/new/choose">file an issue</a>.</p>
</div>
<p>Create a <a href="https://app.bugsnag.com/user/new/">Bugsnag account</a>, create a new project for leak reporting and grab an <strong>API key</strong>. Make sure the app has the <code>android.permission.INTERNET</code> permission then add the <a href="https://docs.bugsnag.com/platforms/android/">latest version</a> of the Bugsnag Android client library to <code>build.gradle</code>:</p>
<div class="codehilite"><pre><span></span><span class="n">dependencies</span> <span class="o">{</span>
  <span class="c1">// debugImplementation because LeakCanary should only run in debug builds.</span>
  <span class="n">debugImplementation</span> <span class="s1">&#39;com.squareup.leakcanary:leakcanary-android:2.2&#39;</span>
  <span class="n">debugImplementation</span> <span class="s2">&quot;com.bugsnag:bugsnag-android:$bugsnagVersion&quot;</span>
<span class="o">}</span>
</pre></div>

<div class="admonition info">
<p class="admonition-title">Info</p>
<p>If you&rsquo;re only using Bugsnag for uploading leaks, then you do not need to set up the Bugsnag Gradle plugin or to configure the API key in your app manifest.</p>
</div>
<p>Create a new <code>BugsnagLeakUploader</code>:</p>
<div class="codehilite"><pre><span></span><span class="k">import</span> <span class="nn">android.app.Application</span>
<span class="k">import</span> <span class="nn">com.bugsnag.android.Client</span>
<span class="k">import</span> <span class="nn">com.bugsnag.android.MetaData</span>
<span class="k">import</span> <span class="nn">leakcanary.DefaultOnHeapAnalyzedListener</span>
<span class="k">import</span> <span class="nn">leakcanary.OnHeapAnalyzedListener</span>
<span class="k">import</span> <span class="nn">shark.HeapAnalysis</span>
<span class="k">import</span> <span class="nn">shark.HeapAnalysisFailure</span>
<span class="k">import</span> <span class="nn">shark.HeapAnalysisSuccess</span>
<span class="k">import</span> <span class="nn">shark.Leak</span>
<span class="k">import</span> <span class="nn">shark.LeakTrace</span>
<span class="k">import</span> <span class="nn">shark.LibraryLeak</span>

<span class="k">class</span> <span class="nc">BugsnagLeakUploader</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">:</span> <span class="n">Application</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">OnHeapAnalyzedListener</span> <span class="p">{</span>

  <span class="k">private</span> <span class="k">val</span> <span class="py">defaultLeakListener</span> <span class="p">=</span> <span class="n">DefaultOnHeapAnalyzedListener</span><span class="p">.</span><span class="n">create</span><span class="p">()</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">bugsnagClient</span><span class="p">:</span> <span class="n">Client</span>

  <span class="n">init</span> <span class="p">{</span>
    <span class="n">bugsnagClient</span> <span class="p">=</span> <span class="n">Client</span><span class="p">(</span>
        <span class="n">applicationContext</span><span class="p">,</span>
        <span class="n">BUGSNAG_API_KEY</span><span class="p">,</span>
        <span class="n">DO_NOT_ENABLE_EXCEPTION_HANDLER</span>
    <span class="p">)</span>
    <span class="n">bugsnagClient</span><span class="p">.</span><span class="n">setSendThreads</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onHeapAnalyzed</span><span class="p">(</span><span class="n">heapAnalysis</span><span class="p">:</span> <span class="n">HeapAnalysis</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Delegate to default behavior (notification and saving result)</span>
    <span class="n">defaultLeakListener</span><span class="p">.</span><span class="n">onHeapAnalyzed</span><span class="p">(</span><span class="n">heapAnalysis</span><span class="p">)</span>

    <span class="k">when</span> <span class="p">(</span><span class="n">heapAnalysis</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">is</span> <span class="n">HeapAnalysisSuccess</span> <span class="p">-&gt;</span> <span class="p">{</span>
        <span class="k">val</span> <span class="py">allLeakTraces</span> <span class="p">=</span> <span class="n">heapAnalysis</span>
            <span class="p">.</span><span class="n">allLeaks</span>
            <span class="p">.</span><span class="n">toList</span><span class="p">()</span>
            <span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">leak</span> <span class="p">-&gt;</span>
              <span class="n">leak</span><span class="p">.</span><span class="n">leakTraces</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">leakTrace</span> <span class="p">-&gt;</span> <span class="n">leak</span> <span class="n">to</span> <span class="n">leakTrace</span> <span class="p">}</span>
            <span class="p">}</span>

        <span class="n">allLeakTraces</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="p">(</span><span class="n">leak</span><span class="p">,</span> <span class="n">leakTrace</span><span class="p">)</span> <span class="p">-&gt;</span>
          <span class="k">val</span> <span class="py">exception</span> <span class="p">=</span> <span class="n">FakeReportingException</span><span class="p">(</span><span class="n">leak</span><span class="p">.</span><span class="n">shortDescription</span><span class="p">)</span>
          <span class="n">bugsnagClient</span><span class="p">.</span><span class="n">notify</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span> <span class="p">{</span> <span class="n">report</span> <span class="p">-&gt;</span>
            <span class="k">val</span> <span class="py">bugsnagMetaData</span> <span class="p">=</span> <span class="n">report</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">metaData</span>
            <span class="n">bugsnagMetaData</span><span class="p">.</span><span class="n">addHeapAnalysis</span><span class="p">(</span><span class="n">heapAnalysis</span><span class="p">)</span>
            <span class="n">bugsnagMetaData</span><span class="p">.</span><span class="n">addLeak</span><span class="p">(</span><span class="n">leak</span><span class="p">)</span>
            <span class="n">bugsnagMetaData</span><span class="p">.</span><span class="n">addLeakTrace</span><span class="p">(</span><span class="n">leakTrace</span><span class="p">)</span>
            <span class="n">report</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">groupingHash</span> <span class="p">=</span> <span class="n">leak</span><span class="p">.</span><span class="n">signature</span>
          <span class="p">}</span>
        <span class="p">}</span>

      <span class="p">}</span>
      <span class="k">is</span> <span class="n">HeapAnalysisFailure</span> <span class="p">-&gt;</span> <span class="p">{</span>
        <span class="c1">// Please file any reported failure to</span>
        <span class="c1">// https://github.com/square/leakcanary/issues</span>
        <span class="n">bugsnagClient</span><span class="p">.</span><span class="n">notify</span><span class="p">(</span><span class="n">heapAnalysis</span><span class="p">.</span><span class="n">exception</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">fun</span> <span class="nc">MetaData</span><span class="p">.</span><span class="nf">addHeapAnalysis</span><span class="p">(</span><span class="n">heapAnalysis</span><span class="p">:</span> <span class="n">HeapAnalysisSuccess</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">addToTab</span><span class="p">(</span><span class="s">&quot;Leak&quot;</span><span class="p">,</span> <span class="s">&quot;heapDumpPath&quot;</span><span class="p">,</span> <span class="n">heapAnalysis</span><span class="p">.</span><span class="n">heapDumpFile</span><span class="p">.</span><span class="n">absolutePath</span><span class="p">)</span>
    <span class="n">heapAnalysis</span><span class="p">.</span><span class="n">metadata</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="p">-&gt;</span>
      <span class="n">addToTab</span><span class="p">(</span><span class="s">&quot;Leak&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">addToTab</span><span class="p">(</span><span class="s">&quot;Leak&quot;</span><span class="p">,</span> <span class="s">&quot;analysisDurationMs&quot;</span><span class="p">,</span> <span class="n">heapAnalysis</span><span class="p">.</span><span class="n">analysisDurationMillis</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">fun</span> <span class="nc">MetaData</span><span class="p">.</span><span class="nf">addLeak</span><span class="p">(</span><span class="n">leak</span><span class="p">:</span> <span class="n">Leak</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">addToTab</span><span class="p">(</span><span class="s">&quot;Leak&quot;</span><span class="p">,</span> <span class="s">&quot;libraryLeak&quot;</span><span class="p">,</span> <span class="n">leak</span> <span class="k">is</span> <span class="n">LibraryLeak</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">leak</span> <span class="k">is</span> <span class="n">LibraryLeak</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">addToTab</span><span class="p">(</span><span class="s">&quot;Leak&quot;</span><span class="p">,</span> <span class="s">&quot;libraryLeakPattern&quot;</span><span class="p">,</span> <span class="n">leak</span><span class="p">.</span><span class="n">pattern</span><span class="p">.</span><span class="n">toString</span><span class="p">())</span>
      <span class="n">addToTab</span><span class="p">(</span><span class="s">&quot;Leak&quot;</span><span class="p">,</span> <span class="s">&quot;libraryLeakDescription&quot;</span><span class="p">,</span> <span class="n">leak</span><span class="p">.</span><span class="n">description</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">fun</span> <span class="nc">MetaData</span><span class="p">.</span><span class="nf">addLeakTrace</span><span class="p">(</span><span class="n">leakTrace</span><span class="p">:</span> <span class="n">LeakTrace</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">addToTab</span><span class="p">(</span><span class="s">&quot;Leak&quot;</span><span class="p">,</span> <span class="s">&quot;retainedHeapByteSize&quot;</span><span class="p">,</span> <span class="n">leakTrace</span><span class="p">.</span><span class="n">retainedHeapByteSize</span><span class="p">)</span>
    <span class="n">addToTab</span><span class="p">(</span><span class="s">&quot;Leak&quot;</span><span class="p">,</span> <span class="s">&quot;signature&quot;</span><span class="p">,</span> <span class="n">leakTrace</span><span class="p">.</span><span class="n">signature</span><span class="p">)</span>
    <span class="n">addToTab</span><span class="p">(</span><span class="s">&quot;Leak&quot;</span><span class="p">,</span> <span class="s">&quot;leakTrace&quot;</span><span class="p">,</span> <span class="n">leakTrace</span><span class="p">.</span><span class="n">toString</span><span class="p">())</span>
  <span class="p">}</span>

  <span class="k">class</span> <span class="nc">FakeReportingException</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">:</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

  <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">const</span> <span class="k">val</span> <span class="py">BUGSNAG_API_KEY</span> <span class="p">=</span> <span class="n">YOUR_BUGSNAG_API_KEY</span>
    <span class="k">private</span> <span class="k">const</span> <span class="k">val</span> <span class="py">DO_NOT_ENABLE_EXCEPTION_HANDLER</span> <span class="p">=</span> <span class="k">false</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Set <a href="/leakcanary/api/leakcanary-android-core/leakcanary/-leak-canary/-config/on-heap-analyzed-listener/">LeakCanary.config.onHeapAnalyzedListener</a> to <code>BugsnagLeakUploader</code>:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">DebugExampleApplication</span> <span class="p">:</span> <span class="n">ExampleApplication</span><span class="p">()</span> <span class="p">{</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">()</span>
    <span class="n">LeakCanary</span><span class="p">.</span><span class="n">config</span> <span class="p">=</span> <span class="n">LeakCanary</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span>
        <span class="n">onHeapAnalyzedListener</span> <span class="p">=</span> <span class="n">BugsnagLeakUploader</span><span class="p">(</span><span class="n">applicationContext</span> <span class="p">=</span> <span class="k">this</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>You should start seeing leaks reported into Bugsnag, grouped by their leak signature:</p>
<p><img alt="list" src="../images/bugsnag-list.png" /></p>
<p>The <code>LEAK</code> tab contains the leak trace: </p>
<p><img alt="leak" src="../images/bugsnag-leak.png" /></p>
<h2 id="matching-known-library-leaks">Matching known library leaks<a class="headerlink" href="#matching-known-library-leaks" title="Permanent link">&para;</a></h2>
<p>Set <a href="/leakcanary/api/leakcanary-android-core/leakcanary/-leak-canary/-config/reference-matchers/">LeakCanary.Config.referenceMatchers</a> to a list that builds on top of <a href="/leakcanary/api/shark-android/shark/-android-reference-matchers/app-defaults/">AndroidReferenceMatchers.appDefaults</a>:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">DebugExampleApplication</span> <span class="p">:</span> <span class="n">ExampleApplication</span><span class="p">()</span> <span class="p">{</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">()</span>
    <span class="n">LeakCanary</span><span class="p">.</span><span class="n">config</span> <span class="p">=</span> <span class="n">LeakCanary</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span>
        <span class="n">referenceMatchers</span> <span class="p">=</span> <span class="n">AndroidReferenceMatchers</span><span class="p">.</span><span class="n">appDefaults</span> <span class="p">+</span>
            <span class="n">AndroidReferenceMatchers</span><span class="p">.</span><span class="n">staticFieldLeak</span><span class="p">(</span>
                <span class="n">className</span> <span class="p">=</span> <span class="s">&quot;com.samsing.SomeSingleton&quot;</span><span class="p">,</span>
                <span class="n">fieldName</span> <span class="p">=</span> <span class="s">&quot;sContext&quot;</span><span class="p">,</span>
                <span class="n">description</span> <span class="p">=</span> <span class="s">&quot;SomeSingleton has a static field leaking a context.&quot;</span><span class="p">,</span>
                <span class="n">patternApplies</span> <span class="p">=</span> <span class="p">{</span>
                  <span class="n">manufacturer</span> <span class="p">==</span> <span class="s">&quot;Samsing&quot;</span> <span class="p">&amp;&amp;</span> <span class="n">sdkInt</span> <span class="p">==</span> <span class="m">26</span>
                <span class="p">}</span>
            <span class="p">)</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h2 id="ignoring-specific-activities-or-fragment-classes">Ignoring specific activities or fragment classes<a class="headerlink" href="#ignoring-specific-activities-or-fragment-classes" title="Permanent link">&para;</a></h2>
<p>Sometimes a 3<sup>rd</sup> party library provides its own activities or fragments which contain a number of bugs leading to leaks of those specific 3<sup>rd</sup> party activities and fragments. You should push hard on that library to fix their memory leaks as it&rsquo;s directly impacting your application. That being said, until those are fixed, you have two options:</p>
<ol>
<li>Add the specific leaks as known library leaks (see <a href="#matching-known-library-leaks">Matching known library leaks</a>). LeakCanary will run when those leaks are detected and then report them as known library leaks.</li>
<li>Disable LeakCanary automatic activity or fragment watching (e.g. <code>AppWatcher.config = AppWatcher.config.copy(watchActivities = false)</code>) and then manually pass objects to <code>AppWatcher.objectWatcher.watch</code>.</li>
</ol>
<h2 id="identifying-leaking-objects-and-labeling-objects">Identifying leaking objects and labeling objects<a class="headerlink" href="#identifying-leaking-objects-and-labeling-objects" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">DebugExampleApplication</span> <span class="p">:</span> <span class="n">ExampleApplication</span><span class="p">()</span> <span class="p">{</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">()</span>
    <span class="k">val</span> <span class="py">addEntityIdLabel</span> <span class="p">=</span> <span class="n">ObjectInspector</span> <span class="p">{</span> <span class="n">reporter</span> <span class="p">-&gt;</span>
      <span class="n">reporter</span><span class="p">.</span><span class="n">whenInstanceOf</span><span class="p">(</span><span class="s">&quot;com.example.DbEntity&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">instance</span> <span class="p">-&gt;</span>
        <span class="k">val</span> <span class="py">databaseIdField</span> <span class="p">=</span> <span class="n">instance</span><span class="p">[</span><span class="s">&quot;com.example.DbEntity&quot;</span><span class="p">,</span> <span class="s">&quot;databaseId&quot;</span><span class="p">]</span><span class="o">!!</span>
        <span class="k">val</span> <span class="py">databaseId</span> <span class="p">=</span> <span class="n">databaseIdField</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">asInt</span><span class="o">!!</span>
        <span class="n">labels</span> <span class="p">+=</span> <span class="s">&quot;DbEntity.databaseId = $databaseId&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">val</span> <span class="py">singletonsInspector</span> <span class="p">=</span>
      <span class="n">AppSingletonInspector</span><span class="p">(</span><span class="s">&quot;com.example.MySingleton&quot;</span><span class="p">,</span> <span class="s">&quot;com.example.OtherSingleton&quot;</span><span class="p">)</span>

    <span class="k">val</span> <span class="py">mmvmInspector</span> <span class="p">=</span> <span class="n">ObjectInspector</span> <span class="p">{</span> <span class="n">reporter</span> <span class="p">-&gt;</span>
      <span class="n">reporter</span><span class="p">.</span><span class="n">whenInstanceOf</span><span class="p">(</span><span class="s">&quot;com.mmvm.SomeViewModel&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">instance</span> <span class="p">-&gt;</span>
        <span class="k">val</span> <span class="py">destroyedField</span> <span class="p">=</span> <span class="n">instance</span><span class="p">[</span><span class="s">&quot;com.mmvm.SomeViewModel&quot;</span><span class="p">,</span> <span class="s">&quot;destroyed&quot;</span><span class="p">]</span><span class="o">!!</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">destroyedField</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">asBoolean</span><span class="o">!!</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">leakingReasons</span> <span class="p">+=</span> <span class="s">&quot;SomeViewModel.destroyed is true&quot;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">notLeakingReasons</span> <span class="p">+=</span> <span class="s">&quot;SomeViewModel.destroyed is false&quot;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">LeakCanary</span><span class="p">.</span><span class="n">config</span> <span class="p">=</span> <span class="n">LeakCanary</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span>
        <span class="n">objectInspectors</span> <span class="p">=</span> <span class="n">AndroidObjectInspectors</span><span class="p">.</span><span class="n">appDefaults</span> <span class="p">+</span>
            <span class="n">listOf</span><span class="p">(</span><span class="n">addObjectIdLabel</span><span class="p">,</span> <span class="n">singletonsInspector</span><span class="p">,</span> <span class="n">mmvmInspector</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h2 id="running-the-leakcanary-analysis-in-a-separate-process">Running the LeakCanary analysis in a separate process<a class="headerlink" href="#running-the-leakcanary-analysis-in-a-separate-process" title="Permanent link">&para;</a></h2>
<p>LeakCanary runs in your main app process. LeakCanary 2 is optimized to keep memory usage low while analysing and runs in a background thread with priority <code>Process.THREAD_PRIORITY_BACKGROUND</code>. If you find that LeakCanary is still using too much memory or impacting the app process performance, you can configure it to run the analysis in a separate process.</p>
<p>All you have to do is replace the <code>leakcanary-android</code> depedency with <code>leakcanary-android-process</code>:</p>
<div class="codehilite"><pre><span></span><span class="n">dependencies</span> <span class="o">{</span>
  <span class="c1">// debugImplementation &#39;com.squareup.leakcanary:leakcanary-android:${version}&#39;</span>
  <span class="n">debugImplementation</span> <span class="s1">&#39;com.squareup.leakcanary:leakcanary-android-process:${version}&#39;</span>
<span class="o">}</span>
</pre></div>

<p>You can call <a href="/leakcanary/api/leakcanary-android-process/leakcanary/-leak-canary-process/is-in-analyzer-process/">LeakCanaryProcess.isInAnalyzerProcess</a> to check if your Application class is being created in the LeakCanary process. This is useful when configuring libraries like Firebase that may crash when running in an unexpected process.</p>
<h2 id="setting-up-leakcanary-for-different-product-flavors">Setting up LeakCanary for different product flavors<a class="headerlink" href="#setting-up-leakcanary-for-different-product-flavors" title="Permanent link">&para;</a></h2>
<p>You can setup LeakCanary to run in a specific product flavors of your app. For example, create:</p>
<div class="codehilite"><pre><span></span>android {
  flavorDimensions &quot;default&quot;
  productFlavors {
    prod {
      // ...
    }
    qa {
      // ...
    }
    dev {
      // ...
    }
  }
}
</pre></div>

<p>Then, define a custom configuration for the flavor for which you want to enable LeakCanary:</p>
<div class="codehilite"><pre><span></span>android {
  // ...
}
configurations {
    devDebugImplementation {}
}
</pre></div>

<p>You can now add the LeakCanary dependency for that configuration:</p>
<div class="codehilite"><pre><span></span>dependencies {
  devDebugImplementation &quot;com.squareup.leakcanary:leakcanary-android:${version}&quot;
}
</pre></div>

<h2 id="extracting-metadata-from-the-heap-dump">Extracting metadata from the heap dump<a class="headerlink" href="#extracting-metadata-from-the-heap-dump" title="Permanent link">&para;</a></h2>
<p><a href="/leakcanary/api/leakcanary-android-core/leakcanary/-leak-canary/-config/metatada-extractor/">LeakCanary.Config.metatadaExtractor</a> extracts metadata from a heap dump. The metadata is then available in <code>HeapAnalysisSuccess.metadata</code>. <code>LeakCanary.Config.metatadaExtractor</code> defaults to <code>AndroidMetadataExtractor</code> but you can replace it to extract additional metadata from the hprof.</p>
<p>For example, if you want to include the app version name in your heap analysis reports, you need to first store it in memory (e.g. in a static field) and then you can retrieve it in <code>MetadataExtractor</code>.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">DebugExampleApplication</span> <span class="p">:</span> <span class="n">ExampleApplication</span><span class="p">()</span> <span class="p">{</span>

  <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
    <span class="n">@JvmStatic</span>
    <span class="k">lateinit</span> <span class="k">var</span> <span class="py">savedVersionName</span><span class="p">:</span> <span class="n">String</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">()</span>

    <span class="k">val</span> <span class="py">packageInfo</span> <span class="p">=</span> <span class="n">packageManager</span><span class="p">.</span><span class="n">getPackageInfo</span><span class="p">(</span><span class="n">packageName</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
    <span class="n">savedVersionName</span> <span class="p">=</span> <span class="n">packageInfo</span><span class="p">.</span><span class="n">versionName</span>

    <span class="n">LeakCanary</span><span class="p">.</span><span class="n">config</span> <span class="p">=</span> <span class="n">LeakCanary</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span>
        <span class="n">metatadaExtractor</span> <span class="p">=</span> <span class="n">MetadataExtractor</span> <span class="p">{</span> <span class="n">graph</span> <span class="p">-&gt;</span>
          <span class="k">val</span> <span class="py">companionClass</span> <span class="p">=</span>
            <span class="n">graph</span><span class="p">.</span><span class="n">findClassByName</span><span class="p">(</span><span class="s">&quot;com.example.DebugExampleApplication&quot;</span><span class="p">)</span><span class="o">!!</span>

          <span class="k">val</span> <span class="py">versionNameField</span> <span class="p">=</span> <span class="n">companionClass</span><span class="p">[</span><span class="s">&quot;savedVersionName&quot;</span><span class="p">]</span><span class="o">!!</span>
          <span class="k">val</span> <span class="py">versionName</span> <span class="p">=</span> <span class="n">versionNameField</span><span class="p">.</span><span class="n">valueAsInstance</span><span class="o">!!</span><span class="p">.</span><span class="n">readAsJavaString</span><span class="p">()</span><span class="o">!!</span>

          <span class="k">val</span> <span class="py">defaultMetadata</span> <span class="p">=</span> <span class="n">AndroidMetadataExtractor</span><span class="p">.</span><span class="n">extractMetadata</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

          <span class="n">mapOf</span><span class="p">(</span><span class="s">&quot;App Version Name&quot;</span> <span class="n">to</span> <span class="n">versionName</span><span class="p">)</span> <span class="p">+</span> <span class="n">defaultMetadata</span>
        <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h2 id="using-leakcanary-with-obfuscated-apps">Using LeakCanary with obfuscated apps<a class="headerlink" href="#using-leakcanary-with-obfuscated-apps" title="Permanent link">&para;</a></h2>
<p>If obfuscation is turned on then leak traces will be obfuscated. It&rsquo;s possible to automatically deobfuscate leak traces by using a deobfuscation gradle plugin provided by LeakCanary.</p>
<p>You have to add a plugin dependency in your root <code>build.gradle</code> file:</p>
<div class="codehilite"><pre><span></span><span class="n">buildscript</span> <span class="o">{</span>
  <span class="n">dependencies</span> <span class="o">{</span>
    <span class="n">classpath</span> <span class="s1">&#39;com.squareup.leakcanary:leakcanary-deobfuscation-gradle-plugin:${version}&#39;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>And then you need to apply and configure the plugin in your app (or library) specific <code>build.gradle</code> file:</p>
<div class="codehilite"><pre><span></span><span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">&#39;com.android.application&#39;</span>
<span class="c1">// LeakCanary plugin should be added after android application or android library plugin</span>
<span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">&#39;com.squareup.leakcanary.deobfuscation&#39;</span>

<span class="n">leakCanary</span> <span class="o">{</span>
  <span class="c1">// LeakCanary needs to know which variants have obfuscation turned on</span>
  <span class="n">filterObfuscatedVariants</span> <span class="o">{</span> <span class="n">variant</span> <span class="o">-&gt;</span>
    <span class="n">variant</span><span class="o">.</span><span class="na">name</span> <span class="o">==</span> <span class="s2">&quot;debug&quot;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>And that&rsquo;s all. Now you can run LeakCanary on an obfuscated app and leak traces will be automatically deobfuscated.
<strong>Important:</strong> never use this plugin on a variant that you release for production. This plugin copies obfuscation mapping file and puts it inside the .apk, so if you use it on production build then the obfuscation becomes pointless because the code can be easily deobfuscated using mapping file.</p>
<h2 id="detecting-leaks-in-jvm-applications">Detecting leaks in JVM applications<a class="headerlink" href="#detecting-leaks-in-jvm-applications" title="Permanent link">&para;</a></h2>
<p>While LeakCanary was designed to work out of the box on Android, it can run on any JVM with a bit of configuration.</p>
<p>Add the ObjectWatcher and Shark dependencies to your build file:</p>
<div class="codehilite"><pre><span></span><span class="n">dependencies</span> <span class="o">{</span>
  <span class="n">implementation</span> <span class="s1">&#39;com.squareup.leakcanary:leakcanary-object-watcher:2.2&#39;</span>
  <span class="n">implementation</span> <span class="s1">&#39;com.squareup.leakcanary:shark:2.2&#39;</span>
<span class="o">}</span>
</pre></div>

<p>Define a <code>HotSpotHeapDumper</code> to dump the heap:</p>
<div class="codehilite"><pre><span></span><span class="k">import</span> <span class="nn">com.sun.management.HotSpotDiagnosticMXBean</span>
<span class="k">import</span> <span class="nn">java.lang.management.ManagementFactory</span>

<span class="k">object</span> <span class="nc">HotSpotHeapDumper</span> <span class="p">{</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">mBean</span><span class="p">:</span> <span class="n">HotSpotDiagnosticMXBean</span> <span class="k">by</span> <span class="n">lazy</span> <span class="p">{</span>
    <span class="k">val</span> <span class="py">server</span> <span class="p">=</span> <span class="n">ManagementFactory</span><span class="p">.</span><span class="n">getPlatformMBeanServer</span><span class="p">()</span>
    <span class="n">ManagementFactory</span><span class="p">.</span><span class="n">newPlatformMXBeanProxy</span><span class="p">(</span>
        <span class="n">server</span><span class="p">,</span>
        <span class="s">&quot;com.sun.management:type=HotSpotDiagnostic&quot;</span><span class="p">,</span>
        <span class="n">HotSpotDiagnosticMXBean</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span>
    <span class="p">)</span>
  <span class="p">}</span>

  <span class="k">fun</span> <span class="nf">dumpHeap</span><span class="p">(</span><span class="n">fileName</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">mBean</span><span class="p">.</span><span class="n">dumpHeap</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">LIVE</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">const</span> <span class="k">val</span> <span class="py">LIVE</span> <span class="p">=</span> <span class="k">true</span>
<span class="p">}</span>
</pre></div>

<p>Define a <code>JvmHeapAnalyzer</code> to analyze the heap when objects are retained and print the result to the console:</p>
<div class="codehilite"><pre><span></span><span class="k">import</span> <span class="nn">leakcanary.GcTrigger</span>
<span class="k">import</span> <span class="nn">leakcanary.ObjectWatcher</span>
<span class="k">import</span> <span class="nn">leakcanary.OnObjectRetainedListener</span>
<span class="k">import</span> <span class="nn">java.io.File</span>
<span class="k">import</span> <span class="nn">java.text.SimpleDateFormat</span>
<span class="k">import</span> <span class="nn">java.util.Date</span>
<span class="k">import</span> <span class="nn">java.util.Locale.US</span>

<span class="k">class</span> <span class="nc">JvmHeapAnalyzer</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">objectWatcher</span><span class="p">:</span> <span class="n">ObjectWatcher</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">OnObjectRetainedListener</span> <span class="p">{</span>

  <span class="k">private</span> <span class="k">val</span> <span class="py">fileNameFormat</span> <span class="p">=</span> <span class="n">SimpleDateFormat</span><span class="p">(</span><span class="n">DATE_PATTERN</span><span class="p">,</span> <span class="n">US</span><span class="p">)</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onObjectRetained</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">GcTrigger</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">runGc</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">objectWatcher</span><span class="p">.</span><span class="n">retainedObjectCount</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span>
    <span class="p">}</span>
    <span class="k">val</span> <span class="py">fileName</span> <span class="p">=</span> <span class="n">fileNameFormat</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">Date</span><span class="p">())</span>
    <span class="k">val</span> <span class="py">hprofFile</span> <span class="p">=</span> <span class="n">File</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>

    <span class="n">println</span><span class="p">(</span><span class="s">&quot;Dumping the heap to ${hprofFile.absolutePath}&quot;</span><span class="p">)</span>
    <span class="n">HotSpotHeapDumper</span><span class="p">.</span><span class="n">dumpHeap</span><span class="p">(</span><span class="n">hprofFile</span><span class="p">.</span><span class="n">absolutePath</span><span class="p">)</span>

    <span class="k">val</span> <span class="py">analyzer</span> <span class="p">=</span> <span class="n">HeapAnalyzer</span><span class="p">(</span>
        <span class="n">OnAnalysisProgressListener</span> <span class="p">{</span> <span class="n">step</span> <span class="p">-&gt;</span>
          <span class="n">println</span><span class="p">(</span><span class="s">&quot;Analysis in progress, working on: ${step.name}&quot;</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="k">val</span> <span class="py">heapDumpAnalysis</span> <span class="p">=</span> <span class="n">analyzer</span><span class="p">.</span><span class="n">analyze</span><span class="p">(</span>
        <span class="n">heapDumpFile</span> <span class="p">=</span> <span class="n">hprofFile</span><span class="p">,</span>
        <span class="n">leakingObjectFinder</span> <span class="p">=</span> <span class="n">KeyedWeakReferenceFinder</span><span class="p">,</span>
        <span class="n">computeRetainedHeapSize</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
        <span class="n">objectInspectors</span> <span class="p">=</span> <span class="n">ObjectInspectors</span><span class="p">.</span><span class="n">jdkDefaults</span>
    <span class="p">)</span>
    <span class="n">println</span><span class="p">(</span><span class="n">heapDumpAnalysis</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">const</span> <span class="k">val</span> <span class="py">DATE_PATTERN</span> <span class="p">=</span> <span class="s">&quot;yyyy-MM-dd_HH-mm-ss_SSS&#39;.hprof&#39;&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Create an <code>ObjectWatcher</code> instance and configure it to watch objects for 5 seconds before notifying a <code>JvmHeapAnalyzer</code> instance:</p>
<div class="codehilite"><pre><span></span><span class="k">val</span> <span class="py">scheduledExecutor</span> <span class="p">=</span> <span class="n">Executors</span><span class="p">.</span><span class="n">newSingleThreadScheduledExecutor</span><span class="p">()</span>
<span class="k">val</span> <span class="py">objectWatcher</span> <span class="p">=</span> <span class="n">ObjectWatcher</span><span class="p">(</span>
    <span class="n">clock</span> <span class="p">=</span> <span class="n">Clock</span> <span class="p">{</span>
      <span class="n">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span>
    <span class="p">},</span>
    <span class="n">checkRetainedExecutor</span> <span class="p">=</span> <span class="n">Executor</span> <span class="p">{</span> <span class="n">command</span> <span class="p">-&gt;</span>
      <span class="n">scheduledExecutor</span><span class="p">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="n">SECONDS</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="k">val</span> <span class="py">heapAnalyzer</span> <span class="p">=</span> <span class="n">JvmHeapAnalyzer</span><span class="p">(</span><span class="n">objectWatcher</span><span class="p">)</span>
<span class="n">objectWatcher</span><span class="p">.</span><span class="n">addOnObjectRetainedListener</span><span class="p">(</span><span class="n">heapAnalyzer</span><span class="p">)</span>
</pre></div>

<p>Pass objects that you expect to be garbage collected (e.g. closed resources) to the <code>ObjectWatcher</code> instance:</p>
<div class="codehilite"><pre><span></span><span class="n">objectWatcher</span><span class="p">.</span><span class="n">watch</span><span class="p">(</span>
    <span class="n">watchedObject</span> <span class="p">=</span> <span class="n">closedResource</span><span class="p">,</span>
    <span class="n">description</span> <span class="p">=</span> <span class="s">&quot;$closedResource is closed and should be garbage collected&quot;</span>
<span class="p">)</span>
</pre></div>

<p>If you end up using LeakCanary on a JVM, the community will definitely benefit from you experience, so don&rsquo;t hesitate to <a href="https://github.com/square/leakcanary/issues/">let us know</a>!</p>
                
                  
                

              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../fundamentals-fixing-a-memory-leak/" title="Fixing a memory leak" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Fixing a memory leak
              </span>
            </div>
          </a>
        
        
          <a href="../faq/" title="FAQ" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                FAQ
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2015 Square, Inc.
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.808e90bb.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>